# Gemini CLI ä¸­çš„ MCP æœåŠ¡å™¨

æœ¬æ–‡æ¡£æä¾›äº†åœ¨ Gemini CLI ä¸­é…ç½®å’Œä½¿ç”¨æ¨¡å‹ä¸Šä¸‹æ–‡åè®® (MCP) æœåŠ¡å™¨çš„æŒ‡å—ã€‚

## ä»€ä¹ˆæ˜¯ MCP æœåŠ¡å™¨ï¼Ÿ

MCP æœåŠ¡å™¨æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œé€šè¿‡æ¨¡å‹ä¸Šä¸‹æ–‡åè®®å‘ Gemini CLI å…¬å¼€å·¥å…·å’Œèµ„æºï¼Œå…è®¸å®ƒä¸å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æºäº¤äº’ã€‚MCP æœåŠ¡å™¨å……å½“ Gemini æ¨¡å‹ä¸æ‚¨çš„æœ¬åœ°ç¯å¢ƒæˆ–å…¶ä»–æœåŠ¡ï¼ˆå¦‚ APIï¼‰ä¹‹é—´çš„æ¡¥æ¢ã€‚

MCP æœåŠ¡å™¨ä½¿ Gemini CLI èƒ½å¤Ÿï¼š

- **å‘ç°å·¥å…·ï¼š** é€šè¿‡æ ‡å‡†åŒ–æ¨¡å¼å®šä¹‰åˆ—å‡ºå¯ç”¨å·¥å…·ã€å…¶æè¿°å’Œå‚æ•°ã€‚
- **æ‰§è¡Œå·¥å…·ï¼š** ä½¿ç”¨å®šä¹‰çš„å‚æ•°è°ƒç”¨ç‰¹å®šå·¥å…·å¹¶æ¥æ”¶ç»“æ„åŒ–å“åº”ã€‚
- **è®¿é—®èµ„æºï¼š** ä»ç‰¹å®šèµ„æºè¯»å–æ•°æ®ï¼ˆå°½ç®¡ Gemini CLI ä¸»è¦å…³æ³¨å·¥å…·æ‰§è¡Œï¼‰ã€‚

é€šè¿‡ MCP æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥æ‰©å±• Gemini CLI çš„åŠŸèƒ½ï¼Œä»¥æ‰§è¡Œè¶…å‡ºå…¶å†…ç½®åŠŸèƒ½çš„æ“ä½œï¼Œä¾‹å¦‚ä¸æ•°æ®åº“ã€APIã€è‡ªå®šä¹‰è„šæœ¬æˆ–ä¸“ä¸šå·¥ä½œæµäº¤äº’ã€‚

## æ ¸å¿ƒé›†æˆæ¶æ„

Gemini CLI é€šè¿‡å†…ç½®äºæ ¸å¿ƒåŒ… (`packages/core/src/tools/`) ä¸­çš„å¤æ‚å‘ç°å’Œæ‰§è¡Œç³»ç»Ÿä¸ MCP æœåŠ¡å™¨é›†æˆï¼š

### å‘ç°å±‚ (`mcp-client.ts`)

å‘ç°è¿‡ç¨‹ç”± `discoverMcpTools()` åè°ƒï¼Œå®ƒï¼š

1. **è¿­ä»£é…ç½®çš„æœåŠ¡å™¨** ä»æ‚¨çš„ `settings.json` `mcpServers` é…ç½®ä¸­
2. **å»ºç«‹è¿æ¥** ä½¿ç”¨é€‚å½“çš„ä¼ è¾“æœºåˆ¶ï¼ˆStdioã€SSE æˆ–å¯æµå¼ HTTPï¼‰
3. **ä»æ¯ä¸ªæœåŠ¡å™¨è·å–å·¥å…·å®šä¹‰** ä½¿ç”¨ MCP åè®®
4. **æ¸…ç†å’ŒéªŒè¯** å·¥å…·æ¨¡å¼ä»¥ä¸ Gemini API å…¼å®¹
5. **åœ¨å…¨å±€å·¥å…·æ³¨å†Œè¡¨ä¸­æ³¨å†Œå·¥å…·** å…·æœ‰å†²çªè§£å†³åŠŸèƒ½

### æ‰§è¡Œå±‚ (`mcp-tool.ts`)

æ¯ä¸ªå‘ç°çš„ MCP å·¥å…·éƒ½åŒ…è£…åœ¨ `DiscoveredMCPTool` å®ä¾‹ä¸­ï¼Œè¯¥å®ä¾‹ï¼š

- **æ ¹æ®æœåŠ¡å™¨ä¿¡ä»»è®¾ç½®å’Œç”¨æˆ·åå¥½å¤„ç†ç¡®è®¤é€»è¾‘**
- **é€šè¿‡ä½¿ç”¨é€‚å½“çš„å‚æ•°è°ƒç”¨ MCP æœåŠ¡å™¨æ¥ç®¡ç†å·¥å…·æ‰§è¡Œ**
- **å¤„ç† LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·æ˜¾ç¤ºçš„å“åº”**
- **ç»´æŠ¤è¿æ¥çŠ¶æ€** å¹¶å¤„ç†è¶…æ—¶

### ä¼ è¾“æœºåˆ¶

Gemini CLI æ”¯æŒä¸‰ç§ MCP ä¼ è¾“ç±»å‹ï¼š

- **Stdio ä¼ è¾“ï¼š** å¯åŠ¨å­è¿›ç¨‹å¹¶é€šè¿‡ stdin/stdout è¿›è¡Œé€šä¿¡
- **SSE ä¼ è¾“ï¼š** è¿æ¥åˆ°æœåŠ¡å™¨å‘é€äº‹ä»¶ç«¯ç‚¹
- **å¯æµå¼ HTTP ä¼ è¾“ï¼š** ä½¿ç”¨ HTTP æµè¿›è¡Œé€šä¿¡

## å¦‚ä½•è®¾ç½®æ‚¨çš„ MCP æœåŠ¡å™¨

Gemini CLI ä½¿ç”¨ `mcpServers` é…ç½®åœ¨æ‚¨çš„ `settings.json` æ–‡ä»¶ä¸­å®šä½å’Œè¿æ¥ MCP æœåŠ¡å™¨ã€‚æ­¤é…ç½®æ”¯æŒå…·æœ‰ä¸åŒä¼ è¾“æœºåˆ¶çš„å¤šä¸ªæœåŠ¡å™¨ã€‚

### åœ¨ settings.json ä¸­é…ç½® MCP æœåŠ¡å™¨

æ‚¨å¯ä»¥åœ¨ `~/.gemini/settings.json` æ–‡ä»¶ä¸­æˆ–åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­å…¨å±€é…ç½® MCP æœåŠ¡å™¨ï¼Œåˆ›å»ºæˆ–æ‰“å¼€ `.gemini/settings.json` æ–‡ä»¶ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œæ·»åŠ  `mcpServers` é…ç½®å—ã€‚

### é…ç½®ç»“æ„

å°† `mcpServers` å¯¹è±¡æ·»åŠ åˆ°æ‚¨çš„ `settings.json` æ–‡ä»¶ä¸­ï¼š

```json
{ ...æ–‡ä»¶åŒ…å«å…¶ä»–é…ç½®å¯¹è±¡
  "mcpServers": {
    "serverName": {
      "command": "path/to/server",
      "args": ["--arg1", "value1"],
      "env": {
        "API_KEY": "$MY_API_TOKEN"
      },
      "cwd": "./server-directory",
      "timeout": 30000,
      "trust": false
    }
  }
}
```

### é…ç½®å±æ€§

æ¯ä¸ªæœåŠ¡å™¨é…ç½®éƒ½æ”¯æŒä»¥ä¸‹å±æ€§ï¼š

#### å¿…éœ€ï¼ˆä»¥ä¸‹ä¹‹ä¸€ï¼‰

- **`command`** (å­—ç¬¦ä¸²)ï¼šStdio ä¼ è¾“çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
- **`url`** (å­—ç¬¦ä¸²)ï¼šSSE ç«¯ç‚¹ URLï¼ˆä¾‹å¦‚ï¼Œ`"http://localhost:8080/sse"`ï¼‰
- **`httpUrl`** (å­—ç¬¦ä¸²)ï¼šHTTP æµç«¯ç‚¹ URL

#### å¯é€‰

- **`args`** (å­—ç¬¦ä¸²[])ï¼šStdio ä¼ è¾“çš„å‘½ä»¤è¡Œå‚æ•°
- **`headers`** (å¯¹è±¡)ï¼šä½¿ç”¨ `url` æˆ– `httpUrl` æ—¶çš„è‡ªå®šä¹‰ HTTP å¤´
- **`env`** (å¯¹è±¡)ï¼šæœåŠ¡å™¨è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚å€¼å¯ä»¥ä½¿ç”¨ `$VAR_NAME` æˆ– `${VAR_NAME}` è¯­æ³•å¼•ç”¨ç¯å¢ƒå˜é‡
- **`cwd`** (å­—ç¬¦ä¸²)ï¼šStdio ä¼ è¾“çš„å·¥ä½œç›®å½•
- **`timeout`** (æ•°å­—)ï¼šè¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ï¼ˆé»˜è®¤ï¼š600,000 æ¯«ç§’ = 10 åˆ†é’Ÿï¼‰
- **`trust`** (å¸ƒå°”å€¼)ï¼šå½“ `true` æ—¶ï¼Œç»•è¿‡æ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤ï¼ˆé»˜è®¤ï¼š`false`ï¼‰
- **`includeTools`** (å­—ç¬¦ä¸²[])ï¼šè¦ä»æ­¤ MCP æœåŠ¡å™¨åŒ…å«çš„å·¥å…·åç§°åˆ—è¡¨ã€‚æŒ‡å®šåï¼Œåªæœ‰æ­¤å¤„åˆ—å‡ºçš„å·¥å…·å¯ä»æ­¤æœåŠ¡å™¨è·å¾—ï¼ˆç™½åå•è¡Œä¸ºï¼‰ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤å¯ç”¨æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰å·¥å…·ã€‚
- **`excludeTools`** (å­—ç¬¦ä¸²[])ï¼šè¦ä»æ­¤ MCP æœåŠ¡å™¨æ’é™¤çš„å·¥å…·åç§°åˆ—è¡¨ã€‚æ­¤å¤„åˆ—å‡ºçš„å·¥å…·å°†ä¸å¯ç”¨äºæ¨¡å‹ï¼Œå³ä½¿å®ƒä»¬ç”±æœåŠ¡å™¨å…¬å¼€ã€‚**æ³¨æ„ï¼š** `excludeTools` ä¼˜å…ˆäº `includeTools` - å¦‚æœå·¥å…·åŒæ—¶åœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­ï¼Œå®ƒå°†è¢«æ’é™¤ã€‚

### è¿œç¨‹ MCP æœåŠ¡å™¨çš„ OAuth æ”¯æŒ

Gemini CLI æ”¯æŒä½¿ç”¨ SSE æˆ– HTTP ä¼ è¾“çš„è¿œç¨‹ MCP æœåŠ¡å™¨çš„ OAuth 2.0 èº«ä»½éªŒè¯ã€‚è¿™ä½¿å¾—å¯ä»¥å®‰å…¨è®¿é—®éœ€è¦èº«ä»½éªŒè¯çš„ MCP æœåŠ¡å™¨ã€‚

#### è‡ªåŠ¨ OAuth å‘ç°

å¯¹äºæ”¯æŒ OAuth å‘ç°çš„æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥çœç•¥ OAuth é…ç½®ï¼Œè®© CLI è‡ªåŠ¨å‘ç°å®ƒï¼š

```json
{
  "mcpServers": {
    "discoveredServer": {
      "url": "https://api.example.com/sse"
    }
  }
}
```

CLI å°†è‡ªåŠ¨ï¼š

- æ£€æµ‹æœåŠ¡å™¨ä½•æ—¶éœ€è¦ OAuth èº«ä»½éªŒè¯ï¼ˆ401 å“åº”ï¼‰
- ä»æœåŠ¡å™¨å…ƒæ•°æ®å‘ç° OAuth ç«¯ç‚¹
- å¦‚æœæ”¯æŒï¼Œæ‰§è¡ŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ
- å¤„ç† OAuth æµç¨‹å’Œä»¤ç‰Œç®¡ç†

#### èº«ä»½éªŒè¯æµç¨‹

è¿æ¥åˆ°å¯ç”¨ OAuth çš„æœåŠ¡å™¨æ—¶ï¼š

1. **åˆå§‹è¿æ¥å°è¯•** å¤±è´¥å¹¶æ˜¾ç¤º 401 æœªæˆæƒ
2. **OAuth å‘ç°** æ‰¾åˆ°æˆæƒå’Œä»¤ç‰Œç«¯ç‚¹
3. **æµè§ˆå™¨æ‰“å¼€** è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ï¼ˆéœ€è¦æœ¬åœ°æµè§ˆå™¨è®¿é—®ï¼‰
4. **æˆæƒç ** äº¤æ¢ä¸ºè®¿é—®ä»¤ç‰Œ
5. **ä»¤ç‰Œå®‰å…¨å­˜å‚¨** ä»¥å¤‡å°†æ¥ä½¿ç”¨
6. **è¿æ¥é‡è¯•** æˆåŠŸå¹¶å¸¦æœ‰æœ‰æ•ˆä»¤ç‰Œ

#### æµè§ˆå™¨é‡å®šå‘è¦æ±‚

**é‡è¦ï¼š** OAuth èº«ä»½éªŒè¯è¦æ±‚æ‚¨çš„æœ¬åœ°æœºå™¨å¯ä»¥ï¼š

- æ‰“å¼€ Web æµè§ˆå™¨è¿›è¡Œèº«ä»½éªŒè¯
- åœ¨ `http://localhost:7777/oauth/callback` ä¸Šæ¥æ”¶é‡å®šå‘

æ­¤åŠŸèƒ½ä¸é€‚ç”¨äºï¼š

- æ²¡æœ‰æµè§ˆå™¨è®¿é—®æƒé™çš„æ— å¤´ç¯å¢ƒ
- æ²¡æœ‰ X11 è½¬å‘çš„è¿œç¨‹ SSH ä¼šè¯
- æ²¡æœ‰æµè§ˆå™¨æ”¯æŒçš„å®¹å™¨åŒ–ç¯å¢ƒ

#### ç®¡ç† OAuth èº«ä»½éªŒè¯

ä½¿ç”¨ `/mcp auth` å‘½ä»¤ç®¡ç† OAuth èº«ä»½éªŒè¯ï¼š

```bash
# åˆ—å‡ºéœ€è¦èº«ä»½éªŒè¯çš„æœåŠ¡å™¨
/mcp auth

# ä½¿ç”¨ç‰¹å®šæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName

# å¦‚æœä»¤ç‰Œè¿‡æœŸï¼Œé‡æ–°è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName
```

#### OAuth é…ç½®å±æ€§

- **`enabled`** (å¸ƒå°”å€¼)ï¼šä¸ºæ­¤æœåŠ¡å™¨å¯ç”¨ OAuth
- **`clientId`** (å­—ç¬¦ä¸²)ï¼šOAuth å®¢æˆ·ç«¯æ ‡è¯†ç¬¦ï¼ˆåŠ¨æ€æ³¨å†Œæ—¶å¯é€‰ï¼‰
- **`clientSecret`** (å­—ç¬¦ä¸²)ï¼šOAuth å®¢æˆ·ç«¯å¯†é’¥ï¼ˆå…¬å…±å®¢æˆ·ç«¯å¯é€‰ï¼‰
- **`authorizationUrl`** (å­—ç¬¦ä¸²)ï¼šOAuth æˆæƒç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`tokenUrl`** (å­—ç¬¦ä¸²)ï¼šOAuth ä»¤ç‰Œç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`scopes`** (å­—ç¬¦ä¸²[])ï¼šæ‰€éœ€çš„ OAuth èŒƒå›´
- **`redirectUri`** (å­—ç¬¦ä¸²)ï¼šè‡ªå®šä¹‰é‡å®šå‘ URIï¼ˆé»˜è®¤ä¸º `http://localhost:7777/oauth/callback`ï¼‰
- **`tokenParamName`** (å­—ç¬¦ä¸²)ï¼šSSE URL ä¸­ä»¤ç‰Œçš„æŸ¥è¯¢å‚æ•°åç§°
- **`audiences`** (å­—ç¬¦ä¸²[])ï¼šä»¤ç‰Œæœ‰æ•ˆçš„å—ä¼—

#### ä»¤ç‰Œç®¡ç†

OAuth ä»¤ç‰Œä¼šè‡ªåŠ¨ï¼š

- **å®‰å…¨å­˜å‚¨** åœ¨ `~/.gemini/mcp-oauth-tokens.json` ä¸­
- **è¿‡æœŸæ—¶åˆ·æ–°**ï¼ˆå¦‚æœåˆ·æ–°ä»¤ç‰Œå¯ç”¨ï¼‰
- **åœ¨æ¯æ¬¡è¿æ¥å°è¯•å‰éªŒè¯**
- **æ— æ•ˆæˆ–è¿‡æœŸæ—¶æ¸…ç†**

#### èº«ä»½éªŒè¯æä¾›ç¨‹åºç±»å‹

æ‚¨å¯ä»¥ä½¿ç”¨ `authProviderType` å±æ€§æŒ‡å®šèº«ä»½éªŒè¯æä¾›ç¨‹åºç±»å‹ï¼š

- **`authProviderType`** (å­—ç¬¦ä¸²)ï¼šæŒ‡å®šèº«ä»½éªŒè¯æä¾›ç¨‹åºã€‚å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š
  - **`dynamic_discovery`** (é»˜è®¤)ï¼šCLI å°†è‡ªåŠ¨ä»æœåŠ¡å™¨å‘ç° OAuth é…ç½®ã€‚
  - **`google_credentials`**ï¼šCLI å°†ä½¿ç”¨ Google åº”ç”¨ç¨‹åºé»˜è®¤å‡­æ® (ADC) å‘æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚å½“ä½¿ç”¨æ­¤æä¾›ç¨‹åºæ—¶ï¼Œæ‚¨å¿…é¡»æŒ‡å®šæ‰€éœ€çš„èŒƒå›´ã€‚

```json
{
  "mcpServers": {
    "googleCloudServer": {
      "httpUrl": "https://my-gcp-service.run.app/mcp",
      "authProviderType": "google_credentials",
      "oauth": {
        "scopes": ["https://www.googleapis.com/auth/userinfo.email"]
      }
    }
  }
}
```

### ç¤ºä¾‹é…ç½®

#### Python MCP æœåŠ¡å™¨ (Stdio)

```json
{
  "mcpServers": {
    "pythonTools": {
      "command": "python",
      "args": ["-m", "my_mcp_server", "--port", "8080"],
      "cwd": "./mcp-servers/python",
      "env": {
        "DATABASE_URL": "$DB_CONNECTION_STRING",
        "API_KEY": "${EXTERNAL_API_KEY}"
      },
      "timeout": 15000
    }
  }
}
```

#### Node.js MCP æœåŠ¡å™¨ (Stdio)

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["dist/server.js", "--verbose"],
      "cwd": "./mcp-servers/node",
      "trust": true
    }
  }
}
```

#### åŸºäº Docker çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "dockerizedServer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-e",
        "API_KEY",
        "-v",
        "${PWD}:/workspace",
        "my-mcp-server:latest"
      ],
      "env": {
        "API_KEY": "$EXTERNAL_SERVICE_TOKEN"
      }
    }
  }
}
```

#### åŸºäº HTTP çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "httpServer": {
      "httpUrl": "http://localhost:3000/mcp",
      "timeout": 5000
    }
  }
}
```

#### å¸¦æœ‰è‡ªå®šä¹‰å¤´çš„åŸºäº HTTP çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "httpServerWithAuth": {
      "httpUrl": "http://localhost:3000/mcp",
      "headers": {
        "Authorization": "Bearer your-api-token",
        "X-Custom-Header": "custom-value",
        "Content-Type": "application/json"
      },
      "timeout": 5000
    }
  }
}
```

#### å¸¦æœ‰å·¥å…·è¿‡æ»¤çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "filteredServer": {
      "command": "python",
      "args": ["-m", "my_mcp_server"],
      "includeTools": ["safe_tool", "file_reader", "data_processor"],
      // "excludeTools": ["dangerous_tool", "file_deleter"],
      "timeout": 30000
    }
  }
}
```

## å‘ç°è¿‡ç¨‹æ·±å…¥æ¢è®¨

å½“ Gemini CLI å¯åŠ¨æ—¶ï¼Œå®ƒé€šè¿‡ä»¥ä¸‹è¯¦ç»†è¿‡ç¨‹æ‰§è¡Œ MCP æœåŠ¡å™¨å‘ç°ï¼š

### 1. æœåŠ¡å™¨è¿­ä»£å’Œè¿æ¥

å¯¹äº `mcpServers` ä¸­çš„æ¯ä¸ªé…ç½®æœåŠ¡å™¨ï¼š

1. **çŠ¶æ€è·Ÿè¸ªå¼€å§‹ï¼š** æœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `CONNECTING`
2. **ä¼ è¾“é€‰æ‹©ï¼š** åŸºäºé…ç½®å±æ€§ï¼š
   - `httpUrl` â†’ `StreamableHTTPClientTransport`
   - `url` â†’ `SSEClientTransport`
   - `command` â†’ `StdioClientTransport`
3. **å»ºç«‹è¿æ¥ï¼š** MCP å®¢æˆ·ç«¯å°è¯•ä½¿ç”¨é…ç½®çš„è¶…æ—¶è¿›è¡Œè¿æ¥
4. **é”™è¯¯å¤„ç†ï¼š** è¿æ¥å¤±è´¥å°†è¢«è®°å½•ï¼ŒæœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `DISCONNECTED`

### 2. å·¥å…·å‘ç°

æˆåŠŸè¿æ¥åï¼š

1. **å·¥å…·åˆ—è¡¨ï¼š** å®¢æˆ·ç«¯è°ƒç”¨ MCP æœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨ç«¯ç‚¹
2. **æ¨¡å¼éªŒè¯ï¼š** æ¯ä¸ªå·¥å…·çš„å‡½æ•°å£°æ˜éƒ½ç»è¿‡éªŒè¯
3. **å·¥å…·è¿‡æ»¤ï¼š** å·¥å…·æ ¹æ® `includeTools` å’Œ `excludeTools` é…ç½®è¿›è¡Œè¿‡æ»¤
4. **åç§°æ¸…ç†ï¼š** å·¥å…·åç§°ç»è¿‡æ¸…ç†ä»¥æ»¡è¶³ Gemini API è¦æ±‚ï¼š
   - æ— æ•ˆå­—ç¬¦ï¼ˆéå­—æ¯æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹ã€è¿å­—ç¬¦ï¼‰æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
   - é•¿åº¦è¶…è¿‡ 63 ä¸ªå­—ç¬¦çš„åç§°é€šè¿‡ä¸­é—´æ›¿æ¢ (`___`) æˆªæ–­

### 3. å†²çªè§£å†³

å½“å¤šä¸ªæœåŠ¡å™¨å…¬å¼€åŒåå·¥å…·æ—¶ï¼š

1. **é¦–æ¬¡æ³¨å†Œè·èƒœï¼š** ç¬¬ä¸€ä¸ªæ³¨å†Œå·¥å…·åç§°çš„æœåŠ¡å™¨è·å¾—æ— å‰ç¼€åç§°
2. **è‡ªåŠ¨æ·»åŠ å‰ç¼€ï¼š** åç»­æœåŠ¡å™¨è·å¾—å¸¦å‰ç¼€çš„åç§°ï¼š`serverName__toolName`
3. **æ³¨å†Œè¡¨è·Ÿè¸ªï¼š** å·¥å…·æ³¨å†Œè¡¨ç»´æŠ¤æœåŠ¡å™¨åç§°ä¸å…¶å·¥å…·ä¹‹é—´çš„æ˜ å°„

### 4. æ¨¡å¼å¤„ç†

å·¥å…·å‚æ•°æ¨¡å¼ç»è¿‡æ¸…ç†ä»¥ä¸ Gemini API å…¼å®¹ï¼š

- **`$schema` å±æ€§** è¢«åˆ é™¤
- **`additionalProperties`** è¢«å‰¥ç¦»
- **å¸¦æœ‰ `default` çš„ `anyOf`** åˆ é™¤äº†å…¶é»˜è®¤å€¼ï¼ˆVertex AI å…¼å®¹æ€§ï¼‰
- **é€’å½’å¤„ç†** é€‚ç”¨äºåµŒå¥—æ¨¡å¼

### 5. è¿æ¥ç®¡ç†

å‘ç°åï¼š

- **æŒä¹…è¿æ¥ï¼š** æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨ä¿æŒå…¶è¿æ¥
- **æ¸…ç†ï¼š** ä¸æä¾›å¯ç”¨å·¥å…·çš„æœåŠ¡å™¨çš„è¿æ¥ä¼šè‡ªåŠ¨å…³é—­
- **çŠ¶æ€æ›´æ–°ï¼š** æœ€ç»ˆæœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `CONNECTED` æˆ– `DISCONNECTED`

## å·¥å…·æ‰§è¡Œæµç¨‹

å½“ Gemini æ¨¡å‹å†³å®šä½¿ç”¨ MCP å·¥å…·æ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹æ‰§è¡Œæµç¨‹ï¼š

### 1. å·¥å…·è°ƒç”¨

æ¨¡å‹ç”Ÿæˆä¸€ä¸ª `FunctionCall`ï¼Œå…¶ä¸­åŒ…å«ï¼š

- **å·¥å…·åç§°ï¼š** æ³¨å†Œåç§°ï¼ˆå¯èƒ½å¸¦æœ‰å‰ç¼€ï¼‰
- **å‚æ•°ï¼š** ä¸å·¥å…·å‚æ•°æ¨¡å¼åŒ¹é…çš„ JSON å¯¹è±¡

### 2. ç¡®è®¤è¿‡ç¨‹

æ¯ä¸ª `DiscoveredMCPTool` éƒ½å®ç°å¤æ‚çš„ç¡®è®¤é€»è¾‘ï¼š

#### åŸºäºä¿¡ä»»çš„ç»•è¿‡

```typescript
if (this.trust) {
  return false; // æ— éœ€ç¡®è®¤
}
```

#### åŠ¨æ€å…è®¸åˆ—è¡¨

ç³»ç»Ÿç»´æŠ¤å†…éƒ¨å…è®¸åˆ—è¡¨ï¼Œç”¨äºï¼š

- **æœåŠ¡å™¨çº§åˆ«ï¼š** `serverName` â†’ æ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·éƒ½å—ä¿¡ä»»
- **å·¥å…·çº§åˆ«ï¼š** `serverName.toolName` â†’ æ­¤ç‰¹å®šå·¥å…·å—ä¿¡ä»»

#### ç”¨æˆ·é€‰æ‹©å¤„ç†

å½“éœ€è¦ç¡®è®¤æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š

- **ä»…æœ¬æ¬¡æ‰§è¡Œï¼š** ä»…æœ¬æ¬¡æ‰§è¡Œ
- **å§‹ç»ˆå…è®¸æ­¤å·¥å…·ï¼š** æ·»åŠ åˆ°å·¥å…·çº§åˆ«å…è®¸åˆ—è¡¨
- **å§‹ç»ˆå…è®¸æ­¤æœåŠ¡å™¨ï¼š** æ·»åŠ åˆ°æœåŠ¡å™¨çº§åˆ«å…è®¸åˆ—è¡¨
- **å–æ¶ˆï¼š** ä¸­æ­¢æ‰§è¡Œ

### 3. æ‰§è¡Œ

ç¡®è®¤åï¼ˆæˆ–ä¿¡ä»»ç»•è¿‡ï¼‰ï¼š

1. **å‚æ•°å‡†å¤‡ï¼š** å‚æ•°æ ¹æ®å·¥å…·çš„æ¨¡å¼è¿›è¡ŒéªŒè¯
2. **MCP è°ƒç”¨ï¼š** åº•å±‚ `CallableTool` ä½¿ç”¨ä»¥ä¸‹å†…å®¹è°ƒç”¨æœåŠ¡å™¨ï¼š

   ```typescript
   const functionCalls = [
     {
       name: this.serverToolName, // åŸå§‹æœåŠ¡å™¨å·¥å…·åç§°
       args: params,
     },
   ];
   ```

3. **å“åº”å¤„ç†ï¼š** ç»“æœæ ¼å¼åŒ–ä¸º LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·æ˜¾ç¤º

### 4. å“åº”å¤„ç†

æ‰§è¡Œç»“æœåŒ…å«ï¼š

- **`llmContent`ï¼š** è¯­è¨€æ¨¡å‹çš„åŸå§‹å“åº”éƒ¨åˆ†
- **`returnDisplay`ï¼š** ç”¨æˆ·æ˜¾ç¤ºçš„æ ¼å¼åŒ–è¾“å‡ºï¼ˆé€šå¸¸æ˜¯ markdown ä»£ç å—ä¸­çš„ JSONï¼‰

## å¦‚ä½•ä¸æ‚¨çš„ MCP æœåŠ¡å™¨äº¤äº’

### ä½¿ç”¨ `/mcp` å‘½ä»¤

`/mcp` å‘½ä»¤æä¾›æœ‰å…³æ‚¨çš„ MCP æœåŠ¡å™¨è®¾ç½®çš„å…¨é¢ä¿¡æ¯ï¼š

```bash
/mcp
```

è¿™ä¼šæ˜¾ç¤ºï¼š

- **æœåŠ¡å™¨åˆ—è¡¨ï¼š** æ‰€æœ‰é…ç½®çš„ MCP æœåŠ¡å™¨
- **è¿æ¥çŠ¶æ€ï¼š** `CONNECTED`ã€`CONNECTING` æˆ– `DISCONNECTED`
- **æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯ï¼š** é…ç½®æ‘˜è¦ï¼ˆä¸åŒ…æ‹¬æ•æ„Ÿæ•°æ®ï¼‰
- **å¯ç”¨å·¥å…·ï¼š** æ¯ä¸ªæœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨åŠå…¶æè¿°
- **å‘ç°çŠ¶æ€ï¼š** æ•´ä½“å‘ç°è¿‡ç¨‹çŠ¶æ€

### ç¤ºä¾‹ `/mcp` è¾“å‡º

```
MCP æœåŠ¡å™¨çŠ¶æ€ï¼š

ğŸ“¡ pythonTools (å·²è¿æ¥)
  å‘½ä»¤ï¼špython -m my_mcp_server --port 8080
  å·¥ä½œç›®å½•ï¼š./mcp-servers/python
  è¶…æ—¶ï¼š15000ms
  å·¥å…·ï¼šcalculate_sum, file_analyzer, data_processor

ğŸ”Œ nodeServer (å·²æ–­å¼€è¿æ¥)
  å‘½ä»¤ï¼šnode dist/server.js --verbose
  é”™è¯¯ï¼šè¿æ¥è¢«æ‹’ç»

ğŸ³ dockerizedServer (å·²è¿æ¥)
  å‘½ä»¤ï¼šdocker run -i --rm -e API_KEY my-mcp-server:latest
  å·¥å…·ï¼šdocker__deploy, docker__status

å‘ç°çŠ¶æ€ï¼šå·²å®Œæˆ
```

### å·¥å…·ä½¿ç”¨

ä¸€æ—¦å‘ç°ï¼ŒMCP å·¥å…·å°±åƒå†…ç½®å·¥å…·ä¸€æ ·å¯ä¾› Gemini æ¨¡å‹ä½¿ç”¨ã€‚æ¨¡å‹å°†è‡ªåŠ¨ï¼š

1. **æ ¹æ®æ‚¨çš„è¯·æ±‚é€‰æ‹©é€‚å½“çš„å·¥å…·**
2. **æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†**ï¼ˆé™¤éæœåŠ¡å™¨å—ä¿¡ä»»ï¼‰
3. **ä½¿ç”¨é€‚å½“çš„å‚æ•°æ‰§è¡Œå·¥å…·**
4. **ä»¥ç”¨æˆ·å‹å¥½çš„æ ¼å¼æ˜¾ç¤ºç»“æœ**

## çŠ¶æ€ç›‘æ§å’Œæ•…éšœæ’é™¤

### è¿æ¥çŠ¶æ€

MCP é›†æˆè·Ÿè¸ªå¤šç§çŠ¶æ€ï¼š

#### æœåŠ¡å™¨çŠ¶æ€ (`MCPServerStatus`)

- **`DISCONNECTED`ï¼š** æœåŠ¡å™¨æœªè¿æ¥æˆ–æœ‰é”™è¯¯
- **`CONNECTING`ï¼š** è¿æ¥å°è¯•è¿›è¡Œä¸­
- **`CONNECTED`ï¼š** æœåŠ¡å™¨å·²è¿æ¥å¹¶å‡†å¤‡å°±ç»ª

#### å‘ç°çŠ¶æ€ (`MCPDiscoveryState`)

- **`NOT_STARTED`ï¼š** å‘ç°å°šæœªå¼€å§‹
- **`IN_PROGRESS`ï¼š** å½“å‰æ­£åœ¨å‘ç°æœåŠ¡å™¨
- **`COMPLETED`ï¼š** å‘ç°å®Œæˆï¼ˆæœ‰æˆ–æ²¡æœ‰é”™è¯¯ï¼‰

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### æœåŠ¡å™¨æ— æ³•è¿æ¥

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨æ˜¾ç¤º `DISCONNECTED` çŠ¶æ€

**æ•…éšœæ’é™¤ï¼š**

1. **æ£€æŸ¥é…ç½®ï¼š** éªŒè¯ `command`ã€`args` å’Œ `cwd` æ˜¯å¦æ­£ç¡®
2. **æ‰‹åŠ¨æµ‹è¯•ï¼š** ç›´æ¥è¿è¡ŒæœåŠ¡å™¨å‘½ä»¤ä»¥ç¡®ä¿å…¶æ­£å¸¸å·¥ä½œ
3. **æ£€æŸ¥ä¾èµ–é¡¹ï¼š** ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„åŒ…éƒ½å·²å®‰è£…
4. **æŸ¥çœ‹æ—¥å¿—ï¼š** åœ¨ CLI è¾“å‡ºä¸­æŸ¥æ‰¾é”™è¯¯æ¶ˆæ¯
5. **éªŒè¯æƒé™ï¼š** ç¡®ä¿ CLI å¯ä»¥æ‰§è¡ŒæœåŠ¡å™¨å‘½ä»¤

#### æœªå‘ç°å·¥å…·

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨è¿æ¥ä½†æ²¡æœ‰å¯ç”¨å·¥å…·

**æ•…éšœæ’é™¤ï¼š**

1. **éªŒè¯å·¥å…·æ³¨å†Œï¼š** ç¡®ä¿æ‚¨çš„æœåŠ¡å™¨å®é™…æ³¨å†Œäº†å·¥å…·
2. **æ£€æŸ¥ MCP åè®®ï¼š** ç¡®è®¤æ‚¨çš„æœåŠ¡å™¨æ­£ç¡®å®ç°äº† MCP å·¥å…·åˆ—è¡¨
3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š** æ£€æŸ¥ stderr è¾“å‡ºä»¥æŸ¥æ‰¾æœåŠ¡å™¨ç«¯é”™è¯¯
4. **æµ‹è¯•å·¥å…·åˆ—è¡¨ï¼š** æ‰‹åŠ¨æµ‹è¯•æ‚¨çš„æœåŠ¡å™¨çš„å·¥å…·å‘ç°ç«¯ç‚¹

#### å·¥å…·æœªæ‰§è¡Œ

**ç—‡çŠ¶ï¼š** å·¥å…·å·²å‘ç°ä½†åœ¨æ‰§è¡ŒæœŸé—´å¤±è´¥

**æ•…éšœæ’é™¤ï¼š**

1. **å‚æ•°éªŒè¯ï¼š** ç¡®ä¿æ‚¨çš„å·¥å…·æ¥å—é¢„æœŸçš„å‚æ•°
2. **æ¨¡å¼å…¼å®¹æ€§ï¼š** éªŒè¯æ‚¨çš„è¾“å…¥æ¨¡å¼æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON æ¨¡å¼
3. **é”™è¯¯å¤„ç†ï¼š** æ£€æŸ¥æ‚¨çš„å·¥å…·æ˜¯å¦æŠ›å‡ºæœªå¤„ç†çš„å¼‚å¸¸
4. **è¶…æ—¶é—®é¢˜ï¼š** è€ƒè™‘å¢åŠ  `timeout` è®¾ç½®

#### æ²™ç›’å…¼å®¹æ€§

**ç—‡çŠ¶ï¼š** å¯ç”¨æ²™ç›’æ—¶ MCP æœåŠ¡å™¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**

1. **åŸºäº Docker çš„æœåŠ¡å™¨ï¼š** ä½¿ç”¨åŒ…å«æ‰€æœ‰ä¾èµ–é¡¹çš„ Docker å®¹å™¨
2. **è·¯å¾„å¯è®¿é—®æ€§ï¼š** ç¡®ä¿æœåŠ¡å™¨å¯æ‰§è¡Œæ–‡ä»¶åœ¨æ²™ç›’ä¸­å¯ç”¨
3. **ç½‘ç»œè®¿é—®ï¼š** é…ç½®æ²™ç›’ä»¥å…è®¸å¿…è¦çš„ç½‘ç»œè¿æ¥
4. **ç¯å¢ƒå˜é‡ï¼š** éªŒè¯æ‰€éœ€çš„ç¯å˜é‡æ˜¯å¦å·²ä¼ é€’

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š** ä½¿ç”¨ `--debug` è¿è¡Œ CLI ä»¥è·å–è¯¦ç»†è¾“å‡º
2. **æ£€æŸ¥ stderrï¼š** MCP æœåŠ¡å™¨ stderr è¢«æ•è·å¹¶è®°å½•ï¼ˆINFO æ¶ˆæ¯å·²è¿‡æ»¤ï¼‰
3. **æµ‹è¯•éš”ç¦»ï¼š** åœ¨é›†æˆä¹‹å‰ç‹¬ç«‹æµ‹è¯•æ‚¨çš„ MCP æœåŠ¡å™¨
4. **å¢é‡è®¾ç½®ï¼š** åœ¨æ·»åŠ å¤æ‚åŠŸèƒ½ä¹‹å‰ä»ç®€å•å·¥å…·å¼€å§‹
5. **ç»å¸¸ä½¿ç”¨ `/mcp`ï¼š** åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç›‘æ§æœåŠ¡å™¨çŠ¶æ€

## é‡è¦æ³¨æ„äº‹é¡¹

### å®‰å…¨è€ƒè™‘

- **ä¿¡ä»»è®¾ç½®ï¼š** `trust` é€‰é¡¹ç»•è¿‡æ‰€æœ‰ç¡®è®¤å¯¹è¯æ¡†ã€‚è°¨æ…ä½¿ç”¨ï¼Œä»…é€‚ç”¨äºæ‚¨å®Œå…¨æ§åˆ¶çš„æœåŠ¡å™¨
- **è®¿é—®ä»¤ç‰Œï¼š** é…ç½®åŒ…å« API å¯†é’¥æˆ–ä»¤ç‰Œçš„ç¯å¢ƒå˜é‡æ—¶ï¼Œè¯·æ³¨æ„å®‰å…¨æ€§
- **æ²™ç›’å…¼å®¹æ€§ï¼š** ä½¿ç”¨æ²™ç›’æ—¶ï¼Œç¡®ä¿ MCP æœåŠ¡å™¨åœ¨æ²™ç›’ç¯å¢ƒä¸­å¯ç”¨
- **ç§æœ‰æ•°æ®ï¼š** ä½¿ç”¨èŒƒå›´å¹¿æ³›çš„ä¸ªäººè®¿é—®ä»¤ç‰Œå¯èƒ½å¯¼è‡´å­˜å‚¨åº“ä¹‹é—´ä¿¡æ¯æ³„éœ²

### æ€§èƒ½å’Œèµ„æºç®¡ç†

- **è¿æ¥æŒä¹…æ€§ï¼š** CLI ç»´æŠ¤ä¸æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨çš„æŒä¹…è¿æ¥
- **è‡ªåŠ¨æ¸…ç†ï¼š** ä¸æä¾›å·¥å…·çš„æœåŠ¡å™¨çš„è¿æ¥ä¼šè‡ªåŠ¨å…³é—­
- **è¶…æ—¶ç®¡ç†ï¼š** æ ¹æ®æœåŠ¡å™¨çš„å“åº”ç‰¹æ€§é…ç½®é€‚å½“çš„è¶…æ—¶
- **èµ„æºç›‘æ§ï¼š** MCP æœåŠ¡å™¨ä½œä¸ºå•ç‹¬çš„è¿›ç¨‹è¿è¡Œå¹¶æ¶ˆè€—ç³»ç»Ÿèµ„æº

### æ¨¡å¼å…¼å®¹æ€§

- **å±æ€§å‰¥ç¦»ï¼š** ç³»ç»Ÿè‡ªåŠ¨åˆ é™¤æŸäº›æ¨¡å¼å±æ€§ï¼ˆ`$schema`ã€`additionalProperties`ï¼‰ä»¥ä¸ Gemini API å…¼å®¹
- **åç§°æ¸…ç†ï¼š** å·¥å…·åç§°è‡ªåŠ¨æ¸…ç†ä»¥æ»¡è¶³ API è¦æ±‚
- **å†²çªè§£å†³ï¼š** æœåŠ¡å™¨ä¹‹é—´çš„å·¥å…·åç§°å†²çªé€šè¿‡è‡ªåŠ¨æ·»åŠ å‰ç¼€è§£å†³

è¿™ç§å…¨é¢çš„é›†æˆä½¿ MCP æœåŠ¡å™¨æˆä¸ºæ‰©å±• Gemini CLI åŠŸèƒ½çš„å¼ºå¤§æ–¹å¼ï¼ŒåŒæ—¶ä¿æŒå®‰å…¨æ€§ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ã€‚

## ä»å·¥å…·è¿”å›å¯Œå†…å®¹

MCP å·¥å…·ä¸é™äºè¿”å›ç®€å•æ–‡æœ¬ã€‚æ‚¨å¯ä»¥åœ¨å•ä¸ªå·¥å…·å“åº”ä¸­è¿”å›å¯Œå¤šéƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘å’Œå…¶ä»–äºŒè¿›åˆ¶æ•°æ®ã€‚è¿™ä½¿æ‚¨èƒ½å¤Ÿæ„å»ºå¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨å•ä¸ªå›åˆä¸­å‘æ¨¡å‹æä¾›å„ç§ä¿¡æ¯ã€‚

ä»å·¥å…·è¿”å›çš„æ‰€æœ‰æ•°æ®éƒ½ç»è¿‡å¤„ç†å¹¶ä½œä¸ºä¸Šä¸‹æ–‡å‘é€åˆ°æ¨¡å‹ï¼Œä»¥ä¾›å…¶ä¸‹ä¸€æ¬¡ç”Ÿæˆï¼Œä½¿å…¶èƒ½å¤Ÿæ¨ç†æˆ–æ€»ç»“æ‰€æä¾›çš„ä¿¡æ¯ã€‚

### å·¥ä½œåŸç†

è¦è¿”å›å¯Œå†…å®¹ï¼Œæ‚¨çš„å·¥å…·çš„å“åº”å¿…é¡»ç¬¦åˆ [`CallToolResult`](https://modelcontextprotocol.io/specification/2025-06-18/server/tools#tool-result) çš„ MCP è§„èŒƒã€‚ç»“æœçš„ `content` å­—æ®µåº”è¯¥æ˜¯ä¸€ä¸ª `ContentBlock` å¯¹è±¡æ•°ç»„ã€‚Gemini CLI å°†æ­£ç¡®å¤„ç†æ­¤æ•°ç»„ï¼Œå°†æ–‡æœ¬ä¸äºŒè¿›åˆ¶æ•°æ®åˆ†ç¦»å¹¶å°†å…¶æ‰“åŒ…ä»¥ä¾›æ¨¡å‹ä½¿ç”¨ã€‚

æ‚¨å¯ä»¥åœ¨ `content` æ•°ç»„ä¸­æ··åˆå’ŒåŒ¹é…ä¸åŒçš„å†…å®¹å—ç±»å‹ã€‚æ”¯æŒçš„å—ç±»å‹åŒ…æ‹¬ï¼š

- `text`
- `image`
- `audio`
- `resource`ï¼ˆåµŒå…¥å†…å®¹ï¼‰
- `resource_link`

### ç¤ºä¾‹ï¼šè¿”å›æ–‡æœ¬å’Œå›¾åƒ

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSON å“åº”ç¤ºä¾‹ï¼Œæ¥è‡ªä¸€ä¸ª MCP å·¥å…·ï¼Œå®ƒåŒæ—¶è¿”å›æ–‡æœ¬æè¿°å’Œå›¾åƒï¼š

```json
{
  "content": [
    {
      "type": "text",
      "text": "è¿™æ˜¯æ‚¨è¯·æ±‚çš„å¾½æ ‡ã€‚"
    },
    {
      "type": "image",
      "data": "BASE64_ENCODED_IMAGE_DATA_HERE",
      "mimeType": "image/png"
    },
    {
      "type": "text",
      "text": "è¯¥å¾½æ ‡åˆ›å»ºäº 2025 å¹´ã€‚"
    }
  ]
}
```

å½“ Gemini CLI æ”¶åˆ°æ­¤å“åº”æ—¶ï¼Œå®ƒå°†ï¼š

1.  æå–æ‰€æœ‰æ–‡æœ¬å¹¶å°†å…¶ç»„åˆæˆä¸€ä¸ª `functionResponse` éƒ¨åˆ†ä»¥ä¾›æ¨¡å‹ä½¿ç”¨ã€‚
2.  å°†å›¾åƒæ•°æ®ä½œä¸ºå•ç‹¬çš„ `inlineData` éƒ¨åˆ†å‘ˆç°ã€‚
3.  åœ¨ CLI ä¸­æä¾›ç®€æ´ã€ç”¨æˆ·å‹å¥½çš„æ‘˜è¦ï¼ŒæŒ‡ç¤ºå·²æ”¶åˆ°æ–‡æœ¬å’Œå›¾åƒã€‚

è¿™ä½¿æ‚¨èƒ½å¤Ÿæ„å»ºå¤æ‚çš„å·¥å…·ï¼Œå¯ä»¥å‘ Gemini æ¨¡å‹æä¾›ä¸°å¯Œçš„å¤šæ¨¡æ€ä¸Šä¸‹æ–‡ã€‚

## MCP æç¤ºä½œä¸ºæ–œæ å‘½ä»¤

é™¤äº†å·¥å…·ä¹‹å¤–ï¼ŒMCP æœåŠ¡å™¨è¿˜å¯ä»¥å…¬å¼€é¢„å®šä¹‰çš„æç¤ºï¼Œè¿™äº›æç¤ºå¯ä»¥åœ¨ Gemini CLI ä¸­ä½œä¸ºæ–œæ å‘½ä»¤æ‰§è¡Œã€‚è¿™å…è®¸æ‚¨ä¸ºå¸¸è§æˆ–å¤æ‚çš„æŸ¥è¯¢åˆ›å»ºå¿«æ·æ–¹å¼ï¼Œè¿™äº›æŸ¥è¯¢å¯ä»¥è½»æ¾åœ°é€šè¿‡åç§°è°ƒç”¨ã€‚

### åœ¨æœåŠ¡å™¨ä¸Šå®šä¹‰æç¤º

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®šä¹‰æç¤ºçš„ stdio MCP æœåŠ¡å™¨çš„å°ç¤ºä¾‹ï¼š

```ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { z } from 'zod';

const server = new McpServer({
  name: 'prompt-server',
  version: '1.0.0',
});

server.registerPrompt(
  'poem-writer',
  {
    title: 'è¯—æ­Œä½œè€…',
    description: 'å†™ä¸€é¦–ä¼˜ç¾çš„ä¿³å¥',
    argsSchema: { title: z.string(), mood: z.string().optional() },
  },
  ({ title, mood }) => ({
    messages: [
      {
        role: 'user',
        content: {
          type: 'text',
          text: `å†™ä¸€é¦–åä¸º ${title} çš„ä¿³å¥${mood ? `ï¼Œæƒ…ç»ªä¸º ${mood}` : ''}ã€‚è¯·æ³¨æ„ï¼Œä¿³å¥æ˜¯ 5 ä¸ªéŸ³èŠ‚ï¼Œç„¶åæ˜¯ 7 ä¸ªéŸ³èŠ‚ï¼Œç„¶åæ˜¯ 5 ä¸ªéŸ³èŠ‚ã€‚`,
        },
      },
    ],
  }),
);

const transport = new StdioServerTransport();
await server.connect(transport);
```

è¿™å¯ä»¥åŒ…å«åœ¨ `settings.json` çš„ `mcpServers` ä¸‹ï¼š

```json
"nodeServer": {
  "command": "node",
  "args": ["filename.ts"],
}
```

### è°ƒç”¨æç¤º

ä¸€æ—¦å‘ç°æç¤ºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å…¶åç§°ä½œä¸ºæ–œæ å‘½ä»¤è°ƒç”¨å®ƒã€‚CLI å°†è‡ªåŠ¨å¤„ç†å‚æ•°è§£æã€‚

```bash
/poem-writer --title="Gemini CLI" --mood="reverent"
```

æˆ–è€…ï¼Œä½¿ç”¨ä½ç½®å‚æ•°ï¼š

```bash
/poem-writer "Gemini CLI" reverent
```

å½“æ‚¨è¿è¡Œæ­¤å‘½ä»¤æ—¶ï¼ŒGemini CLI ä¼šä½¿ç”¨æä¾›çš„å‚æ•°åœ¨ MCP æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `prompts/get` æ–¹æ³•ã€‚æœåŠ¡å™¨è´Ÿè´£å°†å‚æ•°æ›¿æ¢åˆ°æç¤ºæ¨¡æ¿ä¸­å¹¶è¿”å›æœ€ç»ˆçš„æç¤ºæ–‡æœ¬ã€‚CLI å°†æ­¤æç¤ºå‘é€åˆ°æ¨¡å‹ä»¥æ‰§è¡Œã€‚è¿™æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥è‡ªåŠ¨åŒ–å’Œå…±äº«å¸¸è§å·¥ä½œæµã€‚

## ä½¿ç”¨ `gemini mcp` ç®¡ç† MCP æœåŠ¡å™¨

è™½ç„¶æ‚¨å§‹ç»ˆå¯ä»¥é€šè¿‡æ‰‹åŠ¨ç¼–è¾‘ `settings.json` æ–‡ä»¶æ¥é…ç½® MCP æœåŠ¡å™¨ï¼Œä½† Gemini CLI æä¾›äº†ä¸€ç»„æ–¹ä¾¿çš„å‘½ä»¤æ¥ä»¥ç¼–ç¨‹æ–¹å¼ç®¡ç†æ‚¨çš„æœåŠ¡å™¨é…ç½®ã€‚è¿™äº›å‘½ä»¤ç®€åŒ–äº†æ·»åŠ ã€åˆ—å‡ºå’Œåˆ é™¤ MCP æœåŠ¡å™¨çš„è¿‡ç¨‹ï¼Œè€Œæ— éœ€ç›´æ¥ç¼–è¾‘ JSON æ–‡ä»¶ã€‚

### æ·»åŠ æœåŠ¡å™¨ (`gemini mcp add`)

`add` å‘½ä»¤åœ¨æ‚¨çš„ `settings.json` ä¸­é…ç½®ä¸€ä¸ªæ–°çš„ MCP æœåŠ¡å™¨ã€‚æ ¹æ®èŒƒå›´ (`-s, --scope`)ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°ç”¨æˆ·é…ç½® `~/.gemini/settings.json` æˆ–é¡¹ç›®é…ç½® `.gemini/settings.json` æ–‡ä»¶ä¸­ã€‚

**å‘½ä»¤ï¼š**

```bash
gemini mcp add [é€‰é¡¹] <åç§°> <å‘½ä»¤æˆ– URL> [å‚æ•°...]
```

- `<åç§°>`ï¼šæœåŠ¡å™¨çš„å”¯ä¸€åç§°ã€‚
- `<å‘½ä»¤æˆ– URL>`ï¼šè¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆå¯¹äº `stdio`ï¼‰æˆ– URLï¼ˆå¯¹äº `http`/`sse`ï¼‰ã€‚
- `[å‚æ•°...]`ï¼š`stdio` å‘½ä»¤çš„å¯é€‰å‚æ•°ã€‚

**é€‰é¡¹ï¼ˆæ ‡å¿—ï¼‰ï¼š**

- `-s, --scope`ï¼šé…ç½®èŒƒå›´ï¼ˆç”¨æˆ·æˆ–é¡¹ç›®ï¼‰ã€‚[é»˜è®¤å€¼ï¼šâ€œprojectâ€]
- `-t, --transport`ï¼šä¼ è¾“ç±»å‹ï¼ˆstdioã€sseã€httpï¼‰ã€‚[é»˜è®¤å€¼ï¼šâ€œstdioâ€]
- `-e, --env`ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ -e KEY=valueï¼‰ã€‚
- `-H, --header`ï¼šä¸º SSE å’Œ HTTP ä¼ è¾“è®¾ç½® HTTP å¤´ï¼ˆä¾‹å¦‚ -H "X-Api-Key: abc123" -H "Authorization: Bearer abc123"ï¼‰ã€‚
- `--timeout`ï¼šè®¾ç½®è¿æ¥è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ã€‚
- `--trust`ï¼šä¿¡ä»»æœåŠ¡å™¨ï¼ˆç»•è¿‡æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤æç¤ºï¼‰ã€‚
- `--description`ï¼šè®¾ç½®æœåŠ¡å™¨çš„æè¿°ã€‚
- `--include-tools`ï¼šè¦åŒ…å«çš„å·¥å…·çš„é€—å·åˆ†éš”åˆ—è¡¨ã€‚
- `--exclude-tools`ï¼šè¦æ’é™¤çš„å·¥å…·çš„é€—å·åˆ†éš”åˆ—è¡¨ã€‚

#### æ·»åŠ  stdio æœåŠ¡å™¨

è¿™æ˜¯è¿è¡Œæœ¬åœ°æœåŠ¡å™¨çš„é»˜è®¤ä¼ è¾“æ–¹å¼ã€‚

```bash
# åŸºæœ¬è¯­æ³•
gemini mcp add <åç§°> <å‘½ä»¤> [å‚æ•°...]

# ç¤ºä¾‹ï¼šæ·»åŠ æœ¬åœ°æœåŠ¡å™¨
gemini mcp add my-stdio-server -e API_KEY=123 /path/to/server arg1 arg2 arg3

# ç¤ºä¾‹ï¼šæ·»åŠ æœ¬åœ° python æœåŠ¡å™¨
gemini mcp add python-server python server.py --port 8080
```

#### æ·»åŠ  HTTP æœåŠ¡å™¨

æ­¤ä¼ è¾“é€‚ç”¨äºä½¿ç”¨å¯æµå¼ HTTP ä¼ è¾“çš„æœåŠ¡å™¨ã€‚

```bash
# åŸºæœ¬è¯­æ³•
gemini mcp add --transport http <åç§°> <url>

# ç¤ºä¾‹ï¼šæ·»åŠ  HTTP æœåŠ¡å™¨
gemini mcp add --transport http http-server https://api.example.com/mcp/

# ç¤ºä¾‹ï¼šæ·»åŠ å¸¦æœ‰èº«ä»½éªŒè¯å¤´çš„ HTTP æœåŠ¡å™¨
gemini mcp add --transport http secure-http https://api.example.com/mcp/ --header "Authorization: Bearer abc123"
```

#### æ·»åŠ  SSE æœåŠ¡å™¨

æ­¤ä¼ è¾“é€‚ç”¨äºä½¿ç”¨æœåŠ¡å™¨å‘é€äº‹ä»¶ (SSE) çš„æœåŠ¡å™¨ã€‚

```bash
# åŸºæœ¬è¯­æ³•
gemini mcp add --transport sse <åç§°> <url>

# ç¤ºä¾‹ï¼šæ·»åŠ  SSE æœåŠ¡å™¨
gemini mcp add --transport sse sse-server https://api.example.com/sse/

# ç¤ºä¾‹ï¼šæ·»åŠ å¸¦æœ‰èº«ä»½éªŒè¯å¤´çš„ SSE æœåŠ¡å™¨
gemini mcp add --transport sse secure-sse https://api.example.com/sse/ --header "Authorization: Bearer abc123"
```

### åˆ—å‡ºæœåŠ¡å™¨ (`gemini mcp list`)

è¦æŸ¥çœ‹å½“å‰é…ç½®çš„æ‰€æœ‰ MCP æœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ `list` å‘½ä»¤ã€‚å®ƒæ˜¾ç¤ºæ¯ä¸ªæœåŠ¡å™¨çš„åç§°ã€é…ç½®è¯¦ç»†ä¿¡æ¯å’Œè¿æ¥çŠ¶æ€ã€‚

**å‘½ä»¤ï¼š**

```bash
gemini mcp list
```

**ç¤ºä¾‹è¾“å‡ºï¼š**

```sh
âœ“ stdio-server: command: python3 server.py (stdio) - å·²è¿æ¥
âœ“ http-server: https://api.example.com/mcp (http) - å·²è¿æ¥
âœ— sse-server: https://api.example.com/sse (sse) - å·²æ–­å¼€è¿æ¥
```

### åˆ é™¤æœåŠ¡å™¨ (`gemini mcp remove`)

è¦ä»é…ç½®ä¸­åˆ é™¤æœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ `remove` å‘½ä»¤å’ŒæœåŠ¡å™¨çš„åç§°ã€‚

**å‘½ä»¤ï¼š**

```bash
gemini mcp remove <åç§°>
```

**ç¤ºä¾‹ï¼š**

```bash
gemini mcp remove my-server
```

è¿™å°†æ ¹æ®èŒƒå›´ (`-s, --scope`) åœ¨é€‚å½“çš„ `settings.json` æ–‡ä»¶ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤ `mcpServers` å¯¹è±¡ä¸­çš„â€œmy-serverâ€æ¡ç›®ã€‚
